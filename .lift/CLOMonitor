#!/usr/bin/env bash
# dir=$1 but it is not needed
commit=$2
cmd=$3

IFS=' ' # space delimiter

function version() {
    echo 1
}

# always applicable since this is a custom plugin
function applicable() {
    echo "true"
}

function run() {
  firstResult=1

  installTool

  # TODO custom path and URL
  jsonData=$(clomonitor-linter  --format=json --path Adlik --url https://github.com/Adlik/Adlik)
  securityData=$(echo $jsonData | jq ".report | .security") # TODO do we want more tests then just security?
  securityKeys=$(echo $securityData | jq "keys[]") # list of keys seperated by spaces

  echo "["

  echo $securityKeys | while read -ra key ; do
        # add commas between json objects
        if [ $firstResult -eq 1 ]; then
            firstResult=0
        else
            echo ","
        fi

        testData=$(echo $securityData | jq "."$key)
        readableKey=$(echo $key | tr '_"' ' ') # remove underscores and quotes to make this human readable

        if [ "$(echo $testData | jq ".passed")" = "false" ]; then
            echo "{ \"type\": \"CLO Monitor:$readableKey\", \
                \"message\": \"$(echo $testData | jq ".details")\", \
                \"file\": \"NA\", \
                \"line\": NA, \
                \"details_url\": \"https://clomonitor.io/docs/topics/checks/\" \
              }"
        fi
  done

  echo "]"
}

function installTool() {
  # TODO install rust and cargo?

  # install clomonitor-linter
  #cargo install --git https://github.com/cncf/clomonitor clomonitor-linter

  # TODO add clomonitor to path?

  # TODO install scorecard

  # TODO add github token?

  # TODO install JQ
  :
}

if [[ "$cmd" = "run" ]] ; then
    run
fi
if [[ "$cmd" = "applicable" ]] ; then
    applicable
fi
if [[ "$cmd" = "version" ]] ; then
    version
fi